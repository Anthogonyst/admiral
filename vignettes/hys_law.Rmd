---
title: "Hy's Law Implementation Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Hy's Law Implementation Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(admiral)
library(dplyr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(purrr)
library(admiral.test)
library(lubridate)
library(stringr)
```

# Context
During the drug development process, clinical trials are often required to assess for the potential that the experimental drug can cause severe liver injury, known as a drug induced liver injury (DILI). There are multiple criteria that need to be evaluated to determine and classify a DILI "event". A common rule of thumb for this is, known as Hy's Law, is usually comprised of three parts:

- Elevated alanine transaminase (ALT) or aspartate transaminase (AST) by 3-fold or greater of the upper limit of normal, or 5-fold (in the case of aminotransferases instead of transaminases).
- Elevated serum total bilirubin (BILI) by 2-fold or greater within a window of time, ~14 days after the elevated AST/ALT event.
- No other reason to explain these increased lab values like preexisting liver disease.


# Example
We can use a mixture of `admiral` and basic `tidyverse` functions to assist us in creating an ADLBHY dataset. In the walkthrough below we will use the adlb dataset created from the call `use_ad_template("adlb")`

```{r}
adlb <- admiral_adlb
head(adlb)
```

A standard convention of ADLBHY datasets, are various `CRITX` and `CRITXFL` columns to describe the conditions necessary to reach that particular criterion of Hy's Law and the actual flag itself to indicate whether or not the condition was reached.

Using `mutate()`, `call_derivation()` and `derive_var_merged_exist_flag()`, we can create these columns that indicate the the 3-fold or greater than upper limit of normal of ALT/AST and the 2-fold or greater than upper limit of normal of BILI.

To increase visibility, we will keep columns that a relevant to Hy's Law analysis for now. 

```{r}
adlb_annotated <- adlb %>%
  filter(PARAMCD %in% c("AST", "ALT", "BILI") & is.na(DTYPE)) %>%
  mutate(CRIT1 = case_when(
    PARAMCD == "AST" ~ "AST >=3xULN",
    PARAMCD == "ALT" ~ "ALT >=3xULN",
    PARAMCD == "BILI" ~ "BILI >=2xULN"
  )) %>%
  call_derivation(
    .,
    derivation = derive_var_merged_exist_flag,
    dataset_add = .,
    by_vars = exprs(USUBJID, LBSEQ, PARAMCD, ADT),
    variable_params = list(
      params(
        new_var = CRIT1FL,
        condition = (
          (AVAL / ANRHI >= 3 & PARAMCD %in% c("AST", "ALT")) |
            (AVAL / ANRHI >= 2 & PARAMCD == "BILI")
        )
      )
    )
  ) %>%
  select(STUDYID, USUBJID, PARAMCD, LBSEQ, ADT, AVISIT, ADY, AVAL, ANRHI, CRIT1, CRIT1FL)

head(adlb_annotated)
```

By,

  1) Splitting this into its AST/ALT and BILI subsets, respectively, and 
  2) Joining these two datasets using `derive_vars_joined()` while using the `filter_join` argument to only join together the relevant flagged BILI records that have a corresponding flagged ALT/AST record (prior up to 14 days but may vary for trial/organization) that would indicate a potential Hy's Law event, 

the resulting dataset is helpful for deriving additional parameters.

It may also prove useful for example, a listing where you have to display the two lab-records in one row to showcase the potential event. 

```{r}
ALTAST_records <- adlb_annotated %>%
  filter(PARAMCD %in% c("AST", "ALT"))

BILI_records <- adlb_annotated %>%
  filter(PARAMCD %in% c("BILI"))

HYLAW_records <- derive_vars_joined(
  dataset = ALTAST_records,
  dataset_add = BILI_records,
  by_vars = exprs(STUDYID, USUBJID, ADY),
  order = exprs(ADY),
  filter_join = ADT.join - ADT <= 14 & CRIT1FL == "Y" & CRIT1FL.join == "Y",
  new_vars = exprs(BILI_LBSEQ = LBSEQ, BILI_DT = ADT, BILI_CRITFL = CRIT1FL),
  mode = "first"
)

HYLAW_records %>%
  arrange(desc(BILI_CRITFL), desc(CRIT1FL)) %>%
  head(10)
```

Using `derive_param_exist_flag()` you can create a variety of parameters for your final dataset with AVAL = 1/0 for your specific Hy's Law analysis. Below is an example of how to indicate a potential Hy's Law event, with `PARAMCD` set as `"HYSLAW"` and `PARAM` set to `"ALT/AST >= 3xULN and BILI >= 2xULN"` for **each visit** using the flags from the prior dataset. This method allows for flexibility as well, if you wanted it just for each patient and not each visit, you would remove `AVISIT` and `ADT` from the below code. 

Additional modifications can be made such as:

- Parameter to indicate worsening of condition
- Any sort of baseline/post-baseline based analysis
- Flags for other lab values like ALP if modified in above too

```{r}
HYLAW_records_pts_visits <- HYLAW_records %>%
  select(STUDYID, USUBJID, AVISIT, ADT) %>%
  distinct()

HYLAW_records_fls <- HYLAW_records %>%
  select(STUDYID, USUBJID, AVISIT, ADT, CRIT1FL, BILI_CRITFL) %>%
  distinct()

HYLAW_params <- derive_param_exist_flag(
  dataset_adsl = HYLAW_records_pts_visits,
  dataset_add = HYLAW_records_fls,
  condition = CRIT1FL == "Y" & BILI_CRITFL == "Y",
  false_value = "N",
  missing_value = "N",
  subject_keys = exprs(STUDYID, USUBJID, AVISIT, ADT),
  set_values_to = exprs(
    PARAMCD = "HYSLAW",
    PARAM = "ALT/AST >= 3xULN and BILI >= 2xULN"
  )
)

HYLAW_params %>%
  arrange(desc(AVAL)) %>%
  head()
```

The last step would be binding these rows back to whatever previous dataset is appropriate based on your spec, in this case, it would be best suited to bind back to our `adlb_annotated` object.
