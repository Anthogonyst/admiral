---
title: "Hy's Law Implementation Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Hy's Law Implementation Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(admiral)
library(admiraldev, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(purrr)
library(admiral.test)
library(lubridate)
library(stringr)
library(Tplyr)
```

# Context

During the drug development process, clinical trials are often required to assess for the potential that the experimental drug can cause severe liver injury, known as a drug induced liver injury (DILI). There are multiple criteria that need to be evaluated to determine and classify a DILI "event". A common rule of thumb for this is, known as Hy's Law, is usually comprised of three parts:

- Elevated alanine aminotransaminase (ALT) or aspartate aminotransaminase (AST) by 3-fold or greater of the upper limit of normal.
- Elevated serum total bilirubin (BILI) by 2-fold or greater within a window of time, ~14 days after the elevated AST/ALT event.
- No other reason to explain these increased lab values like preexisting liver disease.


# Example

We can use a mixture of `admiral` and basic `tidyverse` functions to assist us in creating an ADLBHY dataset. In the walkthrough below we will use the adlb dataset created from the call `use_ad_template("adlb")`. Due to the size of the dataset, we only included the following USUBJID's: 01-701-1015, 01-701-1023, 01-701-1028, 01-701-1033, 01-701-1034, 01-701-1047, 01-701-1097, 01-705-1186, 01-705-1292, 01-705-1310, 01-708-1286. 

```{r}
adlb <- admiral_adlb
head(adlb) %>%
  dataset_vignette()
```

## Creating the Appropriate CRITX and CRITXFL Columns

A standard convention of ADLBHY datasets, are various `CRITX` and `CRITXFL` columns to describe the conditions necessary to reach that particular criterion of Hy's Law and the actual flag itself to indicate whether or not the condition was reached.

Using `mutate()`, `call_derivation()` and `derive_var_merged_exist_flag()`, we can create these columns that indicate the the 3-fold or greater than upper limit of normal of ALT/AST and the 2-fold or greater than upper limit of normal of BILI.

To increase visibility and for simplicity, we will retain only columns that are relevant to a Hy's Law analysis for now. 

```{r}
adlb_annotated <- adlb %>%
  filter(PARAMCD %in% c("AST", "ALT", "BILI") & is.na(DTYPE)) %>%
  mutate(CRIT1 = case_when(
    PARAMCD == "AST" ~ "AST >=3xULN",
    PARAMCD == "ALT" ~ "ALT >=3xULN",
    PARAMCD == "BILI" ~ "BILI >=2xULN"
  )) %>%
  call_derivation(
    .,
    derivation = derive_var_merged_exist_flag,
    dataset_add = .,
    by_vars = exprs(USUBJID, LBSEQ, PARAMCD, ADT),
    variable_params = list(
      params(
        new_var = CRIT1FL,
        condition = (
          (AVAL / ANRHI >= 3 & PARAMCD %in% c("AST", "ALT")) |
            (AVAL / ANRHI >= 2 & PARAMCD == "BILI")
        )
      )
    )
  ) %>%
  select(STUDYID, USUBJID, TRT01A, PARAMCD, LBSEQ, ADT, AVISIT, ADY, AVAL, ANRHI, CRIT1, CRIT1FL)

dataset_vignette(adlb_annotated)
```
## Subsetting by LBTESTCD and Joining by Potential Events

By,

  1) Splitting this into its AST/ALT and BILI subsets, respectively, and 
  2) Joining these two datasets using `derive_vars_joined()` while using the `filter_join` argument to only join together the relevant flagged BILI records that have a corresponding flagged ALT/AST record (prior up to 14 days but may vary for trial/organization) that would indicate a potential Hy's Law event, 

the resulting dataset is helpful for deriving additional parameters.

It may also prove useful for example, a listing where you have to display the two lab-records in one row to showcase the potential event. 

```{r}
altast_records <- adlb_annotated %>%
  filter(PARAMCD %in% c("AST", "ALT"))

bili_records <- adlb_annotated %>%
  filter(PARAMCD %in% c("BILI"))

hylaw_records <- derive_vars_joined(
  dataset = altast_records,
  dataset_add = bili_records,
  by_vars = exprs(STUDYID, USUBJID, ADY),
  order = exprs(ADY),
  filter_join = ADT.join - ADT <= 14 & CRIT1FL == "Y" & CRIT1FL.join == "Y",
  new_vars = exprs(BILI_LBSEQ = LBSEQ, BILI_DT = ADT, BILI_CRITFL = CRIT1FL),
  mode = "first"
)

hylaw_records %>%
  arrange(desc(BILI_CRITFL), desc(CRIT1FL)) %>%
  dataset_vignette()
```
## How to Create New Paramters and Rows

Using `derive_param_exist_flag()` you can create a variety of parameters for your final dataset with AVAL = 1/0 for your specific Hy's Law analysis. Below is an example of how to indicate a potential Hy's Law event, with `PARAMCD` set as `"HYSLAW"` and `PARAM` set to `"ALT/AST >= 3xULN and BILI >= 2xULN"` for **each patient** using the flags from the prior dataset. This method allows for flexibility as well, if parameters for each visit was desired, you would add `AVISIT` and `ADT` to the `select()` and `subject_keys` lines as denoted from the following code. 

Additional modifications can be made such as:

- Parameter to indicate worsening of condition
- Any sort of baseline/post-baseline based analysis
- Flags for other lab values like ALP if modified in above too

```{r}
hylaw_records_pts_visits <- hylaw_records %>%
  select(STUDYID, USUBJID, TRT01A) %>% # add AVISIT, ADT for by visit
  distinct()

hylaw_records_fls <- hylaw_records %>%
  select(STUDYID, USUBJID, TRT01A, CRIT1FL, BILI_CRITFL) %>% # add AVISIT, ADT for by visit
  distinct()

hylaw_params <- derive_param_exist_flag(
  dataset_adsl = hylaw_records_pts_visits,
  dataset_add = hylaw_records_fls,
  condition = CRIT1FL == "Y" & BILI_CRITFL == "Y",
  false_value = "N",
  missing_value = "N",
  subject_keys = exprs(STUDYID, USUBJID, TRT01A), # add AVISIT, ADT for by visit
  set_values_to = exprs(
    PARAMCD = "HYSLAW",
    PARAM = "ALT/AST >= 3xULN and BILI >= 2xULN"
  )
)

hylaw_params %>%
  arrange(desc(AVAL)) %>%
  dataset_vignette()
```

The last step would be binding these rows back to whatever previous dataset is appropriate based on your data specifications, in this case, it would be best suited to bind back to our `adlb_annotated` object.

```{r}
adlbhy <- adlb_annotated %>%
  bind_rows(hylaw_params)
```

## Visualize the ADLBHY Dataset

Hopefully this `adlbhy` object created is ready for your organization's standard macro display or code that is previously available for tables and listings related to this analysis. Here we will demonstrate a brief use-case of `Tplyr`:

```{r}
tplyr_table(adlbhy, TRT01A, where = PARAMCD == "HYSLAW") %>%
  add_layer(
    group_count(AVALC, by = "Hy's Law Event") %>%
      set_distinct_by(USUBJID) %>%
      set_format_strings(f_str("xx (xx.x)", n, pct))
  ) %>%
  build() %>%
  select(-starts_with("ord")) %>%
  rename_with(., ~ str_replace_all(., "var1_", ""), starts_with("var1_")) %>%
  arrange(desc(row_label2)) %>%
  knitr::kable()
```

Perhaps it is a listing that is requested, using the prior `HYLAW_records` object created earlier, you can use the `LBSEQ` and `BILI_LBSEQ` as an index to grab the proper lab records from ADLB with a `left_join`.

```{r}
dili_seq <- hylaw_records %>%
  filter(CRIT1FL == "Y" & BILI_CRITFL == "Y") %>%
  select(USUBJID, LBSEQ, BILI_LBSEQ) %>%
  pivot_longer(
    cols = c(LBSEQ, BILI_LBSEQ),
    names_to = "pivot_key",
    values_to = "LBSEQ"
  ) %>%
  select(USUBJID, LBSEQ) %>%
  distinct()

dili_seq %>%
  left_join(adlb, by = c("USUBJID", "LBSEQ")) %>%
  select(STUDYID, USUBJID, TRT01A, PARAM, AVISIT, ADT, AVAL, ANRHI) %>%
  arrange(USUBJID, ADT) %>%
  dataset_vignette()
```
