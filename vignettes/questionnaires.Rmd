---
title: "Creating Questionnaire ADaMs"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating Questionnaire ADaMs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(admiraldev)
```

# Introduction

This article describes creating questionnaire ADaMs. Although questionnaire data
is collected in a single SDTM dataset (`QS`), usually it does not make sense to
create a single `ADQS` dataset for all questionnaire analyses. For example, a
univariate analysis of scores by visit requires different variables than a
time-to-event analysis. Therefore this vignette does not provide a programming
workflow for a complete dataset but provides examples for deriving common types
of questionnaire parameters.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless 
otherwise specified.*

## Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(dplyr)
```

## Example Data

In this vignette we use the example data from the CDISC ADaM Supplements
([Generalized Anxiety Disorder 7-Item Version 2
(GAD-7)](https://www.cdisc.org/standards/foundational/qrs/generalized-anxiety-disorder-7-item-version-2-0),
[Geriatric Depression Scale Short Form
(GDS-SF)](https://www.cdisc.org/standards/foundational/qrs/geriatric-depression-scale-short-form-0)):
```{r echo=FALSE}
suppress_warning(
  qs_gad7 <- tibble::tribble(
    ~QSSEQ, ~QSTESTCD, ~QSTEST, ~VISIT, ~VISITNUM, ~QSDTC, ~QSORRES,
    1L, "GAD0201", "GAD02-Feeling Nervous Anxious or On Edge", "VISIT 1", 1, "2012-11-16", "More than half the days",
    2L, "GAD0202", "GAD02-Not Able to Stop/Control Worrying", "VISIT 1", 1, "2012-11-16", "More than half the days",
    3L, "GAD0203", "GAD02-Worrying Too Much About Things", "VISIT 1", 1, "2012-11-16", "More than half the days",
    4L, "GAD0204", "GAD02-Trouble Relaxing", "VISIT 1", 1, "2012-11-16", "More than half the days",
    5L, "GAD0205", "GAD02-Being Restless Hard to Sit Still", "VISIT 1", 1, "2012-11-16", "Nearly every day",
    6L, "GAD0206", "GAD02-Becoming Easily Annoyed/Irritable", "VISIT 1", 1, "2012-11-16", "Nearly every day",
    7L, "GAD0207", "GAD02-Feel Afraid/Something Awful Happen", "VISIT 1", 1, "2012-11-16", "Several days",
    8L, "GAD0208", "GAD02-Total Score", "VISIT 1", 1, "2012-11-16", "15",
    9L, "GAD0201", "GAD02-Feeling Nervous Anxious or On Edge", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "More than half the days",
    10L, "GAD0202", "GAD02-Not Able to Stop/Control Worrying", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "More than half the days",
    11L, "GAD0203", "GAD02-Worrying Too Much About Things", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "More than half the days",
    12L, "GAD0204", "GAD02-Trouble Relaxing", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "More than half the days",
    13L, "GAD0205", "GAD02-Being Restless Hard to Sit Still", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "Several days",
    14L, "GAD0206", "GAD02-Becoming Easily Annoyed/Irritable", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "Nearly every day",
    15L, "GAD0207", "GAD02-Feel Afraid/Something Awful Happen", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "More than half the days",
    16L, "GAD0208", "GAD02-Total Score", "UNSCHEDULED VISIT 5.01", 501, "2013-04-15", "14",
    17L, "GAD0201", "GAD02-Feeling Nervous Anxious or On Edge", "VISIT 6", 6, "2013-05-15", "More than half the days",
    18L, "GAD0202", "GAD02-Not Able to Stop/Control Worrying", "VISIT 6", 6, "2013-05-15", "More than half the days",
    19L, "GAD0203", "GAD02-Worrying Too Much About Things", "VISIT 6", 6, "2013-05-15", "More than half the days",
    20L, "GAD0204", "GAD02-Trouble Relaxing", "VISIT 6", 6, "2013-05-15", "More than half the days",
    21L, "GAD0205", "GAD02-Being Restless Hard to Sit Still", "VISIT 6", 6, "2013-05-15", "Several days",
    22L, "GAD0206", "GAD02-Becoming Easily Annoyed/Irritable", "VISIT 6", 6, "2013-05-15", "Nearly every day",
    23L, "GAD0207", "GAD02-Feel Afraid/Something Awful Happen", "VISIT 6", 6, "2013-05-15", "Several days",
    24L, "GAD0208", "GAD02-Total Score", "VISIT 6", 6, "2013-05-15", "13",
    25L, "GAD0201", "GAD02-Feeling Nervous Anxious or On Edge", "VISIT 12", 12, "2013-11-14", "Several days",
    26L, "GAD0202", "GAD02-Not Able to Stop/Control Worrying", "VISIT 12", 12, "2013-11-14", "Several days",
    27L, "GAD0203", "GAD02-Worrying Too Much About Things", "VISIT 12", 12, "2013-11-14", "Several days",
    28L, "GAD0204", "GAD02-Trouble Relaxing", "VISIT 12", 12, "2013-11-14", "Several days",
    29L, "GAD0205", "GAD02-Being Restless Hard to Sit Still", "VISIT 12", 12, "2013-11-14", "Several days",
    30L, "GAD0206", "GAD02-Becoming Easily Annoyed/Irritable", "VISIT 12", 12, "2013-11-14", "Several days",
    31L, "GAD0207", "GAD02-Feel Afraid/Something Awful Happen", "VISIT 12", 12, "2013-11-14", "Several days",
    32L, "GAD0208", "GAD02-Total Score", "VISIT 12", 12, "2013-11-14", "7"
  ) %>%
    mutate(
      QSCAT = "GAD-7 V2",
      QSSTRESN = recode(
        QSORRES,
        "Not at all" = 0L,
        "Several days" = 1L,
        "More than half the days" = 2L,
        "Nearly every day" = 3L,
        .default = as.integer(QSORRES)
      )
    ),
  regexpr = "NAs introduced by coercion"
)

qs_gdssf <- tibble::tribble(
  ~QSSEQ, ~QSTEST, ~QSTESTCD, ~VISIT, ~VISITNUM, ~QSDTC, ~QSORRES, ~QSSTRESN,
  1L, "GDS02-Satisfied With Life", "GDS0201", "VISIT 1", 1, "2012-11-16", "YES", 0L,
  2L, "GDS02-Dropped Activities and Interests", "GDS0202", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  3L, "GDS02-Life Is Empty", "GDS0203", "VISIT 1", 1, "2012-11-16", "NO", 0L,
  4L, "GDS02-Bored Often", "GDS0204", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  5L, "GDS02-Good Spirits Most of Time", "GDS0205", "VISIT 1", 1, "2012-11-16", "NO", 1L,
  6L, "GDS02-Afraid of Something Bad Happening", "GDS0206", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  7L, "GDS02-Feel Happy Most of Time", "GDS0207", "VISIT 1", 1, "2012-11-16", "NO", 1L,
  8L, "GDS02-Often Feel Helpless", "GDS0208", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  9L, "GDS02-Prefer to Stay Home", "GDS0209", "VISIT 1", 1, "2012-11-16", "NO", 0L,
  10L, "GDS02-Memory Problems", "GDS0210", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  11L, "GDS02-Wonderful to Be Alive", "GDS0211", "VISIT 1", 1, "2012-11-16", "NO", 1L,
  12L, "GDS02-Feel Worthless", "GDS0212", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  13L, "GDS02-Feel Full of Energy", "GDS0213", "VISIT 1", 1, "2012-11-16", "YES", 0L,
  14L, "GDS02-Feel Hopeless", "GDS0214", "VISIT 1", 1, "2012-11-16", "YES", 1L,
  15L, "GDS02-Most People Better Off Than You", "GDS0215", "VISIT 1", 1, "2012-11-16", "NO", 0L,
  16L, "GDS02-Satisfied With Life", "GDS0201", "VISIT 2", 2, "2012-12-15", "YES", 0L,
  17L, "GDS02-Dropped Activities and Interests", "GDS0202", "VISIT 2", 2, "2012-12-15", "NO", 0L,
  18L, "GDS02-Life Is Empty", "GDS0203", "VISIT 2", 2, "2012-12-15", "NO", 0L,
  19L, "GDS02-Bored Often", "GDS0204", "VISIT 2", 2, "2012-12-15", "YES", 1L,
  20L, "GDS02-Good Spirits Most of Time", "GDS0205", "VISIT 2", 2, "2012-12-15", "NO", 1L,
  21L, "GDS02-Afraid of Something Bad Happening", "GDS0206", "VISIT 2", 2, "2012-12-15", "YES", 1L,
  22L, "GDS02-Feel Happy Most of Time", "GDS0207", "VISIT 2", 2, "2012-12-15", "NO", 1L,
  23L, "GDS02-Often Feel Helpless", "GDS0208", "VISIT 2", 2, "2012-12-15", "YES", 1L,
  24L, "GDS02-Prefer to Stay Home", "GDS0209", "VISIT 2", 2, "2012-12-15", "NO", 0L,
  25L, "GDS02-Memory Problems", "GDS0210", "VISIT 2", 2, "2012-12-15", "NO", 0L,
  26L, "GDS02-Wonderful to Be Alive", "GDS0211", "VISIT 2", 2, "2012-12-15", "NO", 1L,
  27L, "GDS02-Feel Worthless", "GDS0212", "VISIT 2", 2, "2012-12-15", "YES", 1L,
  28L, "GDS02-Feel Full of Energy", "GDS0213", "VISIT 2", 2, "2012-12-15", "YES", 0L,
  29L, "GDS02-Feel Hopeless", "GDS0214", "VISIT 2", 2, "2012-12-15", "YES", 1L,
  30L, "GDS02-Most People Better Off Than You", "GDS0215", "VISIT 2", 2, "2012-12-15", "NO", 0L,
  31L, "GDS02-Satisfied With Life", "GDS0201", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 0L,
  32L, "GDS02-Dropped Activities and Interests", "GDS0202", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 0L,
  33L, "GDS02-Life Is Empty", "GDS0203", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  34L, "GDS02-Bored Often", "GDS0204", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  35L, "GDS02-Good Spirits Most of Time", "GDS0205", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 1L,
  36L, "GDS02-Afraid of Something Bad Happening", "GDS0206", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  37L, "GDS02-Feel Happy Most of Time", "GDS0207", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 0L,
  38L, "GDS02-Often Feel Helpless", "GDS0208", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  39L, "GDS02-Prefer to Stay Home", "GDS0209", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 0L,
  40L, "GDS02-Memory Problems", "GDS0210", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 0L,
  41L, "GDS02-Wonderful to Be Alive", "GDS0211", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 1L,
  42L, "GDS02-Feel Worthless", "GDS0212", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  43L, "GDS02-Feel Full of Energy", "GDS0213", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 0L,
  44L, "GDS02-Feel Hopeless", "GDS0214", "UNSCHEDULED 2.01", 201, "2012-12-28", "YES", 1L,
  45L, "GDS02-Most People Better Off Than You", "GDS0215", "UNSCHEDULED 2.01", 201, "2012-12-28", "NO", 0L,
  47L, "GDS02-Life Is Empty", "GDS0203", "VISIT 3", 3, "2013-01-12", "NO", 0L,
  48L, "GDS02-Bored Often", "GDS0204", "VISIT 3", 3, "2013-01-12", "NO", 0L,
  49L, "GDS02-Good Spirits Most of Time", "GDS0205", "VISIT 3", 3, "2013-01-12", "YES", 0L,
  50L, "GDS02-Afraid of Something Bad Happening", "GDS0206", "VISIT 3", 3, "2013-01-12", "YES", 1L,
  51L, "GDS02-Feel Happy Most of Time", "GDS0207", "VISIT 3", 3, "2013-01-12", "NO", 1L,
  52L, "GDS02-Often Feel Helpless", "GDS0208", "VISIT 3", 3, "2013-01-12", "YES", 1L,
  53L, "GDS02-Prefer to Stay Home", "GDS0209", "VISIT 3", 3, "2013-01-12", "NO", 0L,
  54L, "GDS02-Memory Problems", "GDS0210", "VISIT 3", 3, "2013-01-12", "NO", 0L,
  55L, "GDS02-Wonderful to Be Alive", "GDS0211", "VISIT 3", 3, "2013-01-12", "NO", 1L,
  56L, "GDS02-Feel Worthless", "GDS0212", "VISIT 3", 3, "2013-01-12", "YES", 1L,
  57L, "GDS02-Feel Full of Energy", "GDS0213", "VISIT 3", 3, "2013-01-12", "YES", 0L,
  58L, "GDS02-Feel Hopeless", "GDS0214", "VISIT 3", 3, "2013-01-12", "YES", 1L,
  59L, "GDS02-Most People Better Off Than You", "GDS0215", "VISIT 3", 3, "2013-01-12", "NO", 0L,
  60L, "GDS02-Satisfied With Life", "GDS0201", "VISIT 4", 4, "2013-02-13", "YES", 0L,
  61L, "GDS02-Dropped Activities and Interests", "GDS0202", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  62L, "GDS02-Life Is Empty", "GDS0203", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  63L, "GDS02-Bored Often", "GDS0204", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  64L, "GDS02-Good Spirits Most of Time", "GDS0205", "VISIT 4", 4, "2013-02-13", "YES", 0L,
  65L, "GDS02-Afraid of Something Bad Happening", "GDS0206", "VISIT 4", 4, "2013-02-13", "YES", 1L,
  66L, "GDS02-Feel Happy Most of Time", "GDS0207", "VISIT 4", 4, "2013-02-13", "NO", 1L,
  67L, "GDS02-Often Feel Helpless", "GDS0208", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  68L, "GDS02-Prefer to Stay Home", "GDS0209", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  69L, "GDS02-Memory Problems", "GDS0210", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  70L, "GDS02-Wonderful to Be Alive", "GDS0211", "VISIT 4", 4, "2013-02-13", "NO", 1L,
  71L, "GDS02-Feel Worthless", "GDS0212", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  72L, "GDS02-Feel Full of Energy", "GDS0213", "VISIT 4", 4, "2013-02-13", "YES", 0L,
  73L, "GDS02-Feel Hopeless", "GDS0214", "VISIT 4", 4, "2013-02-13", "NO", 0L,
  74L, "GDS02-Most People Better Off Than You", "GDS0215", "VISIT 4", 4, "2013-02-13", "NO", 0L
) %>%
  mutate(QSCAT = "GDS SHORT FORM")

qs <- bind_rows(qs_gad7, qs_gdssf) %>%
  mutate(
    STUDYID = "STUDYX",
    USUBJID = "P0001",
    .before = everything()
  )

dataset_vignette(qs)

adsl <- tibble::tribble(
  ~STUDYID, ~USUBJID, ~SITEID, ~ITTFL,    ~TRTP, ~TRTSDT,                      ~DTHCAUS,
  "STUDYX",  "P0001",     13L,    "Y", "DRUG A", lubridate::ymd("2012-11-16"), NA_character_
)
```
# Original Items

The original items can be handled in the same way like in a [BDS finding ADaM](bds_finding.html). For example:

```{r eval=TRUE}
adqs <- qs %>%
  # add ADSL variables
  derive_vars_merged(
    dataset_add = adsl,
    new_vars = exprs(TRTSDT, DTHCAUS),
    by_vars = exprs(STUDYID, USUBJID)
  ) %>%
  # add analysis parameter variables
  mutate(
    PARAMCD = QSTESTCD,
    PARAM = QSTEST,
    PARCAT1 = QSCAT,
    AVALC = QSORRES,
    AVAL = QSSTRESN
  ) %>%
  # add timing variables
  derive_vars_dt(new_vars_prefix = "A", dtc = QSDTC) %>%
  derive_vars_dy(reference_date = TRTSDT, source_vars = exprs(ADT)) %>%
  mutate(
    AVISIT = VISIT,
    AVISITN = VISITNUM
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adqs, USUBJID, PARCAT1, ADY, PARAMCD),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, PARCAT1, AVALC, AVAL, ADY, AVISIT)
)
```

We handle unscheduled visits as normal visits. For deriving visits based on
time-windows see [Visit and Period Variables](visits_periods.html#visits) and
for flagging values to be used for analysis `derive_var_extreme_flag()`.

# Scales and Scores

Scales and Scores are often derived as the sum or the average across a subset of
the items. For the GAD-7 questionnaire the total score is derived as the sum.
The `derive_summary_records()` function with `sum()` can be used to derive it as
a new parameter. In the example we derive a separate ADaM dataset for each
questionnaire. Depending on the analysis needs it is also possible that an ADaM
contains more than one questionnaire or all questionnaires.
```{r eval=TRUE}
adgad7 <- adqs %>%
  filter(PARCAT1 == "GAD-7 V2") %>%
  derive_summary_records(
    by_vars = exprs(USUBJID, AVISIT, ADT, ADY),
    analysis_var = AVAL,
    summary_fun = function(x) sum(x, na.rm = TRUE),
    filter = str_detect(PARAMCD, "GAD020[1-7]"),
    set_values_to = exprs(
      PARAMCD = "GAD02TS",
      PARAM = "GAD02-Total Score - Analysis"
    )
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgad7, USUBJID, ADY, PARAMCD),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, AVAL, ADY, AVISIT)
)
```

For the GDS-SF questionnaire the total score is defined as the average of the
item values transformed to the range [0, 15] and rounded up to the next integer.
If more than five items are missing, the total score is considered as missing.
This parameter can be derived by `compute_scales()` and
`derive_summary_records()`:
```{r eval=TRUE}
adgdssf <- adqs %>%
  filter(PARCAT1 == "GDS SHORT FORM") %>%
  derive_summary_records(
    by_vars = exprs(USUBJID, AVISIT, ADT, ADY),
    analysis_var = AVAL,
    summary_fun = function(x) {
      compute_scale(
        x,
        source_range = c(0, 1),
        target_range = c(0, 15),
        min_n = 10
      ) %>%
        ceiling()
    },
    filter = str_detect(PARAMCD, "GDS02[01][0-9]"),
    set_values_to = exprs(
      PARAMCD = "GDS02TS",
      PARAM = "GDS02- Total Score - Analysis"
    )
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgdssf, USUBJID, ADY, PARAMCD),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, AVAL, ADY, AVISIT)
)
```

After deriving the scores by visit baseline and change from baseline variables
can be derived:
```{r eval=TRUE}
adgdssf <- adgdssf %>%
  # flag baseline records (last before treatement start)
  restrict_derivation(
    derivation = derive_var_extreme_flag,
    args = params(
      by_vars = exprs(STUDYID, USUBJID, PARAMCD),
      order = exprs(ADT),
      new_var = ABLFL,
      mode = "last"
    ),
    filter = !is.na(AVAL) & ADT <= TRTSDT
  ) %>%
  # derive baseline and change from baseline variables
  derive_var_base(
    by_vars = exprs(STUDYID, USUBJID, PARAMCD),
    source_var = AVAL,
    new_var = BASE
  ) %>%
  derive_var_chg() %>%
  derive_var_pchg() %>%
  # derive sequence number
  derive_var_obs_number(
    by_vars = exprs(STUDYID, USUBJID),
    order = exprs(PARAMCD, ADT),
    check_type = "error"
  )
```

```{r echo=FALSE}
dataset_vignette(
  adgdssf,
  display_vars = exprs(USUBJID, PARAMCD, PARAM, AVISIT, AVAL, BASE, CHG, PCHG)
)
```

# Time to Deterioration/Improvement {#timetodeterioration}

As time to event parameters require specific variables like `CNSR`, `STARTDT`,
and `EVNTDESC`, it makes sense to create a separate time to event dataset for
them. However, it might be useful to create flags or categorization variables in
`ADQS`. For example
```{r}
adgdssf <- adgdssf %>%
  mutate(
    AVALCAT1 = if_else(
      PARAMCD == "GDS02TS",
      case_when(
        AVAL <= 5 ~ "Normal",
        AVAL <= 10 ~ "Possible Depression",
        AVAL > 10 ~ "Likely Depression"
      ),
      NA_character_
    )
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgdssf, desc(PARAMCD), ADY),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, AVISIT, AVAL, AVALCAT1)
)
```

Then a time to depression parameter can be derived by:
```{r}
# define event
depression_event <- event_source(
  dataset_name = "adqs",
  filter = PARAMCD == "GDS02TS" & AVALCAT1 %in% c("Possible Depression", "Likely Depression"),
  date = ADT,
  set_values_to = exprs(
    EVNTDESC = "DEPRESSION",
    SRCDOM = "ADQS",
    SRCVAR = "ADT",
    SRCSEQ = ASEQ
  )
)

# define censoring at last assessment
last_valid_assessment <- censor_source(
  dataset_name = "adqs",
  filter = PARAMCD == "GDS02TS" & !is.na(AVALCAT1),
  date = ADT,
  set_values_to = exprs(
    EVNTDESC = "LAST ASSESSMENT",
    SRCDOM = "ADQS",
    SRCVAR = "ADT",
    SRCSEQ = ASEQ
  )
)

# define censoring at treatment start (for subjects without assessment)
start <- censor_source(
  dataset_name = "adsl",
  date = TRTSDT,
  set_values_to = exprs(
    EVNTDESC = "TREATMENT START",
    SRCDOM = "ADSL",
    SRCVAR = "TRTSDT"
  )
)

adgdstte <- derive_param_tte(
  dataset_adsl = adsl,
  source_datasets = list(adsl = adsl, adqs = adgdssf),
  start_date = TRTSDT,
  event_conditions = list(depression_event),
  censor_conditions = list(last_valid_assessment, start),
  set_values_to = exprs(
    PARAMCD = "TTDEPR",
    PARAM = "Time to depression"
  )
) %>%
  derive_vars_duration(
    new_var = AVAL,
    start_date = STARTDT,
    end_date = ADT
  )
```

```{r echo=FALSE}
dataset_vignette(
  adgdstte,
  display_vars = exprs(USUBJID, PARAMCD, PARAM, AVAL, CNSR, EVNTDESC, SRCDOM, SRCVAR)
)
```

# Time to Confirmed/Definitive Deterioration/Improvement 

The derivation of confirmed/definitive deterioration/improvement parameters is
very similar to the unconfirmed deterioration parameters except that the event
is not based on `CHGCATy` but on a confirmation flag variable. This confirmation
flag can be derived by `derive_var_confirmation_flag()`. For example, flagging
depressions, which are confirmed by a second assessment at least seven days
later:
```{r}
adgdssf <- adgdssf %>%
  derive_var_confirmation_flag(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT),
    new_var = CDETFL,
    join_vars = exprs(AVALCAT1, ADY),
    join_type = "after",
    filter = AVALCAT1 %in% c("Possible Depression", "Likely Depression") &
      AVALCAT1.join %in% c("Possible Depression", "Likely Depression") &
      ADY.join >= ADY + 7
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgdssf, desc(PARAMCD), ADY),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, ADY, AVALCAT1, CDETFL)
)
```

For flagging deteriorations at two consecutive assessments or considering death
due to progression at the last assessment as confirmation the `tmp_obs_nr_var`
argument is helpful:
```{r}
# flagging depression at two consecutive assessments
adgdssf <- adgdssf %>%
  derive_var_confirmation_flag(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT),
    new_var = CONDETFL,
    join_vars = exprs(AVALCAT1),
    join_type = "after",
    tmp_obs_nr_var = tmp_obs_nr,
    filter = AVALCAT1 %in% c("Possible Depression", "Likely Depression") &
      AVALCAT1.join %in% c("Possible Depression", "Likely Depression") &
      tmp_obs_nr.join == tmp_obs_nr + 1
  ) %>%
  # flagging depression confirmed by
  # - a second depression at least 7 days later or
  # - depression at the last assessment and death due to progression
  derive_var_confirmation_flag(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT),
    new_var = CDTDTHFL,
    join_vars = exprs(AVALCAT1, ADY),
    join_type = "after",
    tmp_obs_nr_var = tmp_obs_nr,
    filter = AVALCAT1 %in% c("Possible Depression", "Likely Depression") & (
      AVALCAT1.join %in% c("Possible Depression", "Likely Depression") & ADY.join >= ADY + 7 |
        tmp_obs_nr == max(tmp_obs_nr.join) & DTHCAUS == "PROGRESSIVE DISEASE")
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgdssf, desc(PARAMCD), ADY),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, ADY, AVALCAT1, CONDETFL, CDTDTHFL)
)
```

For definitive deterioration (deterioration at all following assessments)
parameters summary functions like `all()` can be used in the filter condition:

```{r}
adgdssf <- adgdssf %>%
  derive_var_confirmation_flag(
    by_vars = exprs(USUBJID, PARAMCD),
    order = exprs(ADT),
    new_var = DEFDETFL,
    join_vars = exprs(AVALCAT1),
    join_type = "after",
    filter = AVALCAT1 %in% c("Possible Depression", "Likely Depression") &
      all(AVALCAT1.join %in% c("Possible Depression", "Likely Depression"))
  )
```

```{r echo=FALSE}
dataset_vignette(
  arrange(adgdssf, desc(PARAMCD), ADY),
  display_vars = exprs(USUBJID, PARAMCD, PARAM, ADY, AVALCAT1, DEFDETFL)
)
```

The time-to-event parameter can be derived in the same way as for the
unconfirmed parameters (see [Time to
Deterioration/Improvement](#timetodeterioration))

# Worst/Best Answer

This class of parameters can be used when the worst answer of a set of yes/no answers should be selected. For example, if yes/no answers for "No sleep", "Waking up more than three times", "More than 30 mins to fall asleep" are collected, a parameter for the worst sleeping problems could be derived. In the example no sleeping problems is assumed if all were answered with "no".
```{r eval=FALSE}
derive_param_worst_event(
  adqs,
  by_vars = exprs(USUBJID, AVISIT),
  events = list(
    event(
      condition = PARAMCD == "NO SLEEP" & AVALC == "Y",
      set_values_to = exprs(
        AVALC = "No sleep",
        AVAL = 1
      )
    ),
    event(
      condition = PARAMCD == "WAKE UP" & AVALC == "Y",
      set_values_to = exprs(
        AVALC = "Waking up more than three times",
        AVAL = 2
      )
    ),
    event(
      condition = PARAMCD == "FALL ASLEEP" & AVALC == "Y",
      set_values_to = exprs(
        AVALC = "More than 30 mins to fall asleep",
        AVAL = 3
      )
    ),
    event(
      condition = all(AVALC == "N"),
      set_values_to = exprs(
        AVALC = "No sleeping problems",
        AVAL = 4
      )
    ),
    event(
      condition = TRUE,
      set_values_to = exprs(
        AVALC = "Missing",
        AVAL = 99
      )
    )
  ),
  set_values_to = exprs(
    PARAMCD = "WSP",
    PARAM = "Worst Sleeping Problems"
  )
)
```

# Completion

Parameters for completion like "at least 50% of the questions were answered" can be derived by `derive_summary_records()`.
```{r eval=FALSE}
adqs <- adqs %>%
  derive_summary_records(
    filter = PARCAT1 == "Original Items" & ANL01FL == "Y",
    by_vars = exprs(USUBJID, AVISIT),
    analysis_var = AVAL,
    summary_fun = function(x) sum(!is.na(x)) / 13 >= 0.5,
    set_values_to = exprs(
      PARAMCD = "COMPL50P",
      PARAM = "Completed at least 50% of questions",
      PARCAT1 = "Completion",
      AVALC = if_else(
        AVAL == 1,
        "Completed at least 50% of questions",
        "Completed less than 50% of questions"
      )
    )
  )
```
If missed visits need to be taken into account the expected records can be added to the input dataset by calling `derive_expected_records()`:

```{r eval=FALSE}
adqs <- adqs %>%
  derive_expected_records(
    adqs,
    dataset_expected_obs = parm_visit_ref,
    by_vars = exprs(USUBJID),
    set_values_to = exprs(
      filledin = TRUE,
      PARCAT1 = "Original Item",
      ANL01FL = "Y"
    )
  ) %>%
  derive_summary_records(
    filter = PARCAT1 == "Original Items" & ANL01FL == "Y",
    by_vars = exprs(USUBJID, AVISIT),
    analysis_var = AVAL,
    summary_fun = function(x) sum(!is.na(x)) / 13 >= 0.5,
    set_values_to = exprs(
      PARAMCD = "COMPL50P",
      PARAM = "Completed at least 50% of questions",
      PARCAT1 = "Completion",
      AVALC = if_else(
        AVAL == 1,
        "Completed at least 50% of questions",
        "Completed less than 50% of questions"
      )
    )
  ) %>%
  filter(!filledin)
```
