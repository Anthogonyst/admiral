---
title: "Derive Single Dose Dataset with Missing End of Treatment Date and Datetime Fill-in"
output:  
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Derive Single Dose Dataset with Missing End of Treatment Date and Datetime Fill-in}
  %\VignetteEngine{knitr::rmarkdown}
---

Name: derive_single_dose_fillin
Label: "Derive Single Dose Dataset with Missing End of Treatment Date and Datetime Fill-in" 

Input: ex, dm

# Introduction
For either single drug administration records, or multiple drug administration records covering a range of dates, fill-in of missing treatment end datetime (`EXENDTC`) by substitution with an acceptable alternate, for example date of death, date of datacut may be required. This programming strategy allows the maximum possible number of single dose records to be derived.
The example R script requires the date of datacut `DCUTDT` to be specified correctly, or if not appropriate to use `DCUTDT` as missing treatment end data and missing treatment end datetime could set equal to treatment start date and treatment start datetime. 
All available trial treatments are included, allowing multiple different last dose variables to be created in ad_adae.R if required.

## Required packages
```{r}
library(admiral)
library(admiral.test) # Contains example datasets from the CDISC pilot project
library(dplyr)
library(lubridate)
library(tidyr)

data("admiral_dm")
data("admiral_ex")

dm <- admiral_dm
ex <- admiral_ex

ex <- convert_blanks_to_na(ex)
dm <- convert_blanks_to_na(dm)
```
Derive date of death and set up data cut date to fill in missing treatment end date `EXENDT` and missing treatment end datetime `EXENDTM`.
Alternative approach instead of death date could use last known alive date in ADSL `LSTALVDT`.
```{r}
dm_death <- dm %>%
  select(STUDYID, USUBJID, DTHDTC) %>%
  derive_vars_dtm(
    dtc = DTHDTC,
    flag_imputation = "none",
    new_vars_prefix = "DTH"
  ) %>%
  derive_vars_dtm_to_dt(vars(DTHDTM)) %>%
  # Set up datacut as character snapshot date to use in `EXENDT` and `EXENDTM` imputations
  mutate(
    DCUTDT = as.Date("2015-03-06"),
    DCUTDTM = convert_date_to_dtm(DCUTDT)
  )
```
Select valid dose records, non-missing `EXSTDTC` and `EXDOSE`.
Set up missing `EXDOSFRQ` as QD daily dosing regime.
```{r}
ex_mod <- ex %>%
  filter(!is.na(EXSTDTC) & !is.na(EXDOSE)) %>%
  left_join(dm_death, by = c("STUDYID", "USUBJID")) %>%
  mutate(EXDOSFRQ = if_else(is.na(EXDOSFRQ), "QD", EXDOSFRQ)) %>%
  # Create EXxxDTM variables and replace missing `EXENDTM`.
  derive_vars_dtm(
    dtc = EXSTDTC,
    new_vars_prefix = "EXST",
    date_imputation = "first",
    time_imputation = "first",
    flag_imputation = "none",
  ) %>%
  derive_vars_dtm_to_dt(vars(EXSTDTM)) %>%
  derive_vars_dtm(
    dtc = EXENDTC,
    new_vars_prefix = "EXEN",
    # Maximum imputed treatment end date must not be not greater than date of death or after the datacut date
    max_dates = vars(DTHDTM, DCUTDTM),
    date_imputation = "last",
    time_imputation = "last",
    flag_imputation = "none"
  ) %>%
  derive_vars_dtm_to_dt(vars(EXENDTM)) %>%
  mutate(
    EXENDT = if_else(is.na(EXENDT) & is.na(DTHDT), DCUTDT, EXENDT),
    EXENDT = if_else(is.na(EXENDT) & !is.na(DTHDT), DTHDT, EXENDT),
    EXENDTM = if_else(is.na(EXENDTM) & is.na(DTHDTM), DCUTDTM, EXENDTM),
    EXENDTM = if_else(is.na(EXENDTM) & !is.na(DTHDTM), DTHDTM, EXENDTM)
  ) %>%
  # Select only unique values.
  # Removes duplicated records before final step.
  distinct(STUDYID, USUBJID, EXTRT, EXDOSE, EXDOSFRQ, DCUTDT, DTHDT, EXSTDT, EXSTDTM, EXENDT, EXENDTM, EXSTDTC, EXENDTC)

ex_single <-
  create_single_dose_dataset(
    ex_mod,
    start_date = EXSTDT,
    start_datetime = EXSTDTM,
    end_date = EXENDT,
    end_datetime = EXENDTM,
    keep_source_vars = vars(STUDYID, USUBJID, EXTRT, EXDOSE, EXDOSFRQ, DCUTDT, EXSTDT, EXSTDTM, EXENDT, EXENDTM, EXSTDTC, EXENDTC)
  )
```
